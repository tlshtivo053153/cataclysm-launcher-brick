# サウンドパック機能のリファクタリング分析

## 現在のコード構造と問題点

### モジュール間の依存関係
```
SoundpackManager.hs
├── ArchiveUtils (extractZip)
├── ContentManager (downloadWithCache)
├── Types
└── Events/Soundpack.hs (イベントハンドラから呼び出される)

Events/Soundpack.hs
├── Events.List (handleListEvents)
├── SoundpackManager
└── Types
```

### 主要な問題点

#### 1. SoundpackManager.hsの問題点
- **責務が集中**: インストール、アンインストール、一覧表示の機能が1つのモジュールに集中
- **関数が長大**: `installSoundpack` 関数が46行と長く、複数の責務を担っている
- **重複コード**: キャッシュ使用時と非使用時で重複した処理が存在
- **ハードコードされた値**: `"-master"` のようなサフィックスがハードコードされている
- **エラーハンドリングが一貫性ない**: 一部の操作でエラーハンドリングが不十分

#### 2. Events/Soundpack.hsの問題点
- **重複したパターン**: イベントハンドラ内で同様のパターン（選択確認、エラーチェック）が繰り返されている
- **UIロジックとビジネスロジックの混在**: UIイベント処理とサウンドパック操作のロジックが混在
- **関数名が不明確**: `refreshInstalledSoundpacksList'` のような命名が一貫性ない

#### 3. 型定義の問題点
- **情報不足**: `SoundpackInfo` に必要な情報（バージョン、説明など）が不足
- **表現力不足**: `InstalledSoundpack` にインストール日時などのメタ情報が不足

#### 4. エラーハンドリングの問題点
- **情報不足**: エラーメッセージが具体的でなく、デバッグが困難
- **型安全性**: エラー型が統一されておらず、型安全性が低い

## リファクタリングの目標

1. **責務の分離**: 各モジュールと関数の責務を明確にする
2. **コードの再利用**: 重複コードを排除し、再利用可能な部品に分割
3. **エラーハンドリングの改善**: より具体的で一貫性のあるエラーハンドリングを実装
4. **型安全性の向上**: より表現力のある型定義を採用
5. **テスト容易性の向上**: 依存性注入と純粋な関数を増やす

## リファクタリングの方針

### 1. モジュールの再編成
- `SoundpackManager.hs` を機能ごとに分割:
  - `Soundpack.Install` - インストール関連
  - `Soundpack.Uninstall` - アンインストール関連
  - `Soundpack.List` - 一覧表示関連
  - `Soundpack.Common` - 共通ユーティリティ

### 2. 関数の分割
- `installSoundpack` を小さな関数に分割:
  - ダウンロード処理
  - 展開処理
  - メタデータ生成

### 3. イベントハンドリングの改善
- 共通パターンを抽象化
- UIロジックとビジネスロジックを分離

### 4. 型定義の強化
- より多くの情報を持つ型定義
- 新しいエラー型の導入

### 5. エラーハンドリングの統一
- 一貫したエラー処理パターンの導入
- より詳細なエラー情報の提供